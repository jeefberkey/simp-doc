

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.7.18. How to Manage a TPM Device With SIMP &mdash; SIMP 5.2.1-0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="https://media.readthedocs.org/css/sphinx_rtd_theme.css" type="text/css" />
  
    <link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/css_overrides.css" type="text/css" />
  

  
    <link rel="top" title="SIMP 5.2.1-0 documentation" href="../../index.html"/>
        <link rel="up" title="4.7. SIMP HOWTO Guides" href="../HOWTO.html"/>
        <link rel="next" title="4.8. Package Data" href="../SIMP_Package_Data.html"/>
        <link rel="prev" title="4.7.17. HOWTO Upgrade SIMP" href="Upgrade_SIMP.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../../index.html">
        

        
          
          <img src="../../_static/SIMP_Logo.png" class="logo" />
        
        </a>

        
          
          
            <div class="version">
              5.2.1
            </div>
          
        

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Welcome to the SIMP documentation!</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started_guide/Just_Install.html">1. For the Impatient</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dynamic/Changelog.html">2. Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started_guide/index.html">3. Getting Started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">4. User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../Introduction.html">4.1. Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Client_Management.html">4.2. Client Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../SIMP_Administration.html">4.3. General Administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../User_Management.html">4.4. User Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Hiera_Overview.html">4.5. Hiera Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Troubleshooting.html">4.6. Troubleshooting Common Issues</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../HOWTO.html">4.7. SIMP HOWTO Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="Central_Log_Collection.html">4.7.1. Setup Central Log Collection</a></li>
<li class="toctree-l3"><a class="reference internal" href="Changing_Puppet_Masters.html">4.7.2. Change Puppet Masters</a></li>
<li class="toctree-l3"><a class="reference internal" href="Disable_dhcpd.html">4.7.3. Disable dhcpd</a></li>
<li class="toctree-l3"><a class="reference internal" href="Disable_named.html">4.7.4. Disable named</a></li>
<li class="toctree-l3"><a class="reference internal" href="Discard_Mail_to_Root.html">4.7.5. Discard Mail to Root</a></li>
<li class="toctree-l3"><a class="reference internal" href="Exclude_Repositories.html">4.7.6. Exclude YUM Repositories</a></li>
<li class="toctree-l3"><a class="reference internal" href="NFS.html">4.7.7. Configure NFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="IPTables_NAT_Rules.html">4.7.8. Configure IPTables NAT Rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="Kerberos.html">4.7.9. Enable Kerberos</a></li>
<li class="toctree-l3"><a class="reference internal" href="Managing_Workstation_Infrastructures.html">4.7.10. Manage Workstation Infrastructures</a></li>
<li class="toctree-l3"><a class="reference internal" href="Network_Build.html">4.7.11. Kickstart the Initial Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="Puppetmaster_Backup.html">4.7.12. Backup the Puppet Master</a></li>
<li class="toctree-l3"><a class="reference internal" href="Puppet_Server_NAT.html">4.7.13. Configure a Puppet Server Behind a NAT</a></li>
<li class="toctree-l3"><a class="reference internal" href="Redundant_LDAP.html">4.7.14. Enable Redundent LDAP</a></li>
<li class="toctree-l3"><a class="reference internal" href="SFTP_Restricted_Accounts.html">4.7.15. Enable SFTP Restricted Accounts</a></li>
<li class="toctree-l3"><a class="reference internal" href="SSH_Keys.html">4.7.16. Setup SSH Authorized Keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="Upgrade_SIMP.html">4.7.17. Upgrade SIMP (Coming Soon!)</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">4.7.18. Manage TPM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">4.7.18.1. Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-and-take-ownership">4.7.18.2. Enable and take ownership</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enable-basic-ima-measuring">4.7.18.3. Enable basic IMA measuring</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../SIMP_Package_Data.html">4.8. Package Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#indices-and-tables">4.9. Indices and tables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contributors_guide/index.html">5. Contributing to SIMP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security_conop/index.html">6. Security Concept of Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security_mapping/index.html">7. Security Control Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../help/index.html">8. Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">9. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html#contact">10. Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">11. Glossary of Terms</a></li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">SIMP</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">4. SIMP User Guide</a> &raquo;</li>
      
          <li><a href="../HOWTO.html">4.7. SIMP HOWTO Guides</a> &raquo;</li>
      
    <li>4.7.18. How to Manage a TPM Device With SIMP</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/user_guide/HOWTO/Manage_TPM.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-manage-a-tpm-device-with-simp">
<h1>4.7.18. How to Manage a TPM Device With SIMP<a class="headerlink" href="#how-to-manage-a-tpm-device-with-simp" title="Permalink to this headline">¶</a></h1>
<p>A great effort has been placed on automating the usage of <a class="reference internal" href="../../glossary.html#term-tpm"><span class="xref std std-term">TPM</span></a> <strong>1.2</strong>
devices in SIMP. This document will serve as a guide on how to enable a TPM and
use it in EL 6/7.</p>
<p>Supported TPM features in SIMP:</p>
<blockquote>
<div><ul class="simple">
<li>Taking ownership (but not clear ownership)</li>
<li>Enable basic <a class="reference internal" href="../../glossary.html#term-ima"><span class="xref std std-term">IMA</span></a> measuring<ul>
<li>Setting custom IMA policy (broken)</li>
</ul>
</li>
<li>Enable a TPM-based PKCS#11 interface</li>
<li>(Future) Intel TXT and Trusted Boot</li>
</ul>
</div></blockquote>
<p>We do not support EVM or measured boot at this time. The tools (ima-evm-utils)
are not available on our supported platforms and the kernel provided doesn&#8217;t
support it at this time.</p>
<div class="section" id="overview">
<h2>4.7.18.1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="general-hardware-requirements">
<h3>4.7.18.1.1. General hardware requirements:<a class="headerlink" href="#general-hardware-requirements" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>A host with a TPM 1.2 chip on the motherboard</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="trusted-boot-hardware-requirements">
<h3>4.7.18.1.2. Trusted Boot hardware requirements:<a class="headerlink" href="#trusted-boot-hardware-requirements" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>A CPU with Intel Trusted Execution Technology (TXT)</li>
<li>A chipset with Intel Trusted Execution Technology (TXT)</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="other-non-puppet-requirements">
<h3>4.7.18.1.3. Other non-puppet requirements:<a class="headerlink" href="#other-non-puppet-requirements" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li>A legacy, non-UEFI bootloader</li>
<li>A BIOS password (one should be required to enable the TPM)</li>
<li>Easy physical access to the machine to enter the BIOS password</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="enable-and-take-ownership">
<h2>4.7.18.2. Enable and take ownership<a class="headerlink" href="#enable-and-take-ownership" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">You can see if you have a TPM by either checking with the <code class="docutils literal"><span class="pre">has_tpm</span></code> fact,
the <code class="docutils literal"><span class="pre">status</span></code> section of the tpm structured fact, or by checking the sys
path manually. You can also look for the character device at <code class="docutils literal"><span class="pre">/dev/tpm0</span></code>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ facter -p has_tpm
<span class="nb">true</span>
$ facter -p tpm.status
...
owned: 0,
enabled: 1,
active: 1,
...
$ cat /sys/class/tpm/tpm0/device/active
1
$ file /dev/tpm0
/dev/tpm0: character special <span class="o">(</span>10/224<span class="o">)</span>
</pre></div>
</div>
</li>
<li><p class="first">A TPM would be much less useful if the boot process can&#8217;t be protected. A
BIOS password must be set to make sure no third parties can boot the host.
Please set the admin password and the user password in the BIOS. If there is
an option to require password at boot time, enable it. Do not enable Intel
Platform Trust Techonology (PTT) or Intel TXT at this time.</p>
</li>
<li><p class="first">Before a TPM can be accessed by the operating system, it must first be
enabled. This has to be done in the BIOS. Refer to the documentation
provided with the hardware.</p>
</li>
<li><p class="first">At this point, the TPM module can take over management of the device. Add
<code class="docutils literal"><span class="pre">tpm</span></code> to the host&#8217;s hieradata according to the example below or use the
<code class="docutils literal"><span class="pre">tpm_ownership</span></code> type directly.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">classes</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tpm</span>

<span class="l l-Scalar l-Scalar-Plain">tpm::take_ownership</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="l l-Scalar l-Scalar-Plain">tpm::ownership::advanced_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">tpm_ownership</span></code> type does not support clearing the TPM. The process
could possibly be destructive and has been left to be a manual process.</p>
</div>
</li>
<li><p class="first">Run puppet!</p>
</li>
</ol>
</div>
<div class="section" id="enable-basic-ima-measuring">
<h2>4.7.18.3. Enable basic IMA measuring<a class="headerlink" href="#enable-basic-ima-measuring" title="Permalink to this headline">¶</a></h2>
<p>This section assumes the previous section is complete, the TPM in the host is
owned, and it is being managed with Puppet.</p>
<p>IMA is a neat tool that hashes the contents of a system, and stores that hash in
the TPM. IMA is a kernel-level tool, and needs a few kernel parameters and
reboots to be completely set up.</p>
<ol class="arabic">
<li><p class="first">Follow the above steps ensure the tpm is owned</p>
</li>
<li><p class="first">Modify the hieradata and add just one line:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">tpm::ima</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</li>
<li><p class="first">Run puppet, then reboot.</p>
</li>
</ol>
<div class="section" id="managing-ima-policy">
<h3>4.7.18.3.1. Managing IMA policy<a class="headerlink" href="#managing-ima-policy" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This automated management of IMA policy is disabled for now. The policy generated tends to cause
systems to become read only.</p>
</div>
<p>This module can also support modifying what files IMA watching by editing the
<code class="docutils literal"><span class="pre">/sys/kernel/security/ima/policy</span></code>. Reference the module source file, located
at <code class="docutils literal"><span class="pre">&lt;environment</span> <span class="pre">path&gt;/modules/tpm/manifests/ima/policy.pp</span></code> for further
details on what can and cannot be measured.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Pushing poorly configured policy can result in a read-only system. A reboot
will fix the issue, but with a TPM you will have to enter the password again.
Be very careful not to push bad policy.
That being said, the module itself should generate proper policy and
simultaneously make it difficult to generate malformed policy.</p>
</div>
</div>
<div class="section" id="ima-appraisal">
<h3>4.7.18.3.2. IMA Appraisal<a class="headerlink" href="#ima-appraisal" title="Permalink to this headline">¶</a></h3>
<p>IMA Appraisal is the process that actually measures the state of the file and
will stop changes to the filesystem if there is a issue detected.</p>
<ol class="arabic">
<li><p class="first">Run puppet once with <code class="docutils literal"><span class="pre">tpm::use_ima:</span> <span class="pre">true</span></code>, like it was set up earlier.</p>
</li>
<li><p class="first">Disable the puppet agent on the host</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ puppet agent --disable
</pre></div>
</div>
</li>
<li><p class="first">Make sure <code class="docutils literal"><span class="pre">/</span></code> and <code class="docutils literal"><span class="pre">/home</span></code> are mounted with the <code class="docutils literal"><span class="pre">i_version</span> <span class="pre">option</span></code>. They
are created by default with these options enabled.</p>
</li>
<li><p class="first">Add the <code class="docutils literal"><span class="pre">ima_appraise=fix</span></code> kernel parameter temporarily</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ puppet resource kernel_parameter ima_appraise <span class="nv">ensure</span><span class="o">=</span>present <span class="nv">value</span><span class="o">=</span>fix
</pre></div>
</div>
</li>
<li><p class="first">Reboot</p>
</li>
<li><p class="first">The files on the system must now be measured and saved. In order to do this,
every file owned by root and included in the policy must be touched. This
step will take some time.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ find / <span class="se">\(</span> -fstype rootfs -o -fstype ext4 <span class="se">\)</span> -type f -uid <span class="m">0</span> -exec head -n <span class="m">1</span> <span class="s1">&#39;{}&#39;</span> &gt; /dev/null <span class="se">\;</span>
</pre></div>
</div>
</li>
<li><p class="first">After that process finishes, set the <code class="docutils literal"><span class="pre">ima_appraise</span></code> kernel parameter to
<code class="docutils literal"><span class="pre">enforce</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In kernels above 4.0, we would opt for the <code class="docutils literal"><span class="pre">log</span></code> parameter instead of
<code class="docutils literal"><span class="pre">enforce</span></code>. For now, <code class="docutils literal"><span class="pre">enforce</span></code> is all we have. Be aware, this may cause
your system not to boot.</p>
</div>
</li>
</ol>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span>$ puppet resource kernel_parameter ima_appraise <span class="nv">ensure</span><span class="o">=</span>present <span class="nv">value</span><span class="o">=</span>enforce
$ <span class="c1"># or add it to a puppet manifest</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple">
<li>Reboot</li>
</ol>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../SIMP_Package_Data.html" class="btn btn-neutral float-right" title="4.8. Package Data" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Upgrade_SIMP.html" class="btn btn-neutral" title="4.7.17. HOWTO Upgrade SIMP" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, THE SIMP TEAM.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'4.2.X',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>